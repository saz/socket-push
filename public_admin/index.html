<!doctype html>
<html>
    <head>
        <title>socket-push admin helper</title>
        <script src="http://code.jquery.com/jquery-1.4.2.min.js"></script>
        <style type="text/css">
            fieldset {
                float: left;
                width: 300px;
                margin-bottom: 20px;
                height: 110px;
            }

            h2 {
                clear: left;
            }

            #responseset {
                clear: left;
                margin-top: 20px;
                width: 620px;
            }
        </style>
    </head>
    <body>
        <h1>Admin Helper</h1>
        <div id="invoker"></div>
        <fieldset id="responseset">
        <legend>Response</legend>
        <div id="response"></div>
        </fieldset>
    </body>
    <script>
        var adminHost = 'http://127.0.0.1:8181';
        var services;
        (function($) {
            function initServices() {
                for (i in services) {
                    initService(i, services[i]);
                }
            }

            function initService(serviceName, methods) {
                $('#invoker').append("<h2>" + serviceName + "</h2>");
                for (methodName in methods) {
                    (function(methodName, method) {
                        var formContent = '';
                        for (i in method.params) {
                            var param = method.params[i];
                            formContent += "<tr>" +
                                "<td>" + param.name + "</td>" +
                                "<td><input type='text' name='" + param.name + "'/> (" + param.type + ")</td>" +
                            "</tr>"
                        }
                        var form = "<form id='" + serviceName + "_" + methodName + "' action='#'>" +
                            "<i>" + method.description + "</i>" +
                            "<table>" + formContent + "</table><input type='submit' name='submit' value='send' />" +
                            "</form>";

                        $('#invoker').append("<fieldset><legend>" + methodName + "</legend>" +
                            form +
                        "</fieldset>");

                        $('#' + serviceName + "_" + methodName).submit(function() {
                            try {
                                var values = [];
                                $(this).find('input').each(function() {
                                    if ($(this).attr('name') == 'submit') {
                                        return;
                                    }
                                    values.push($(this).val());
                                });
                                sendRequest(serviceName, methodName, values);
                            }
                            catch (e) {
                                console.log("Error " + e);
                            }
                            return false;
                        });
                    })(methodName, methods[methodName]);
                }
            }

            function sendRequest(serviceName, methodName, args) {
                var route;
                route = adminHost + "/" + serviceName + "/" + methodName;
                args.forEach(function (arg) {
                    route += "/" + encodeURIComponent(arg);
                });
                $.get(route, {}, function(response) {
                    $('#response').html(response > '' ? response : 'OK');
                });
            }

            $("#response").ajaxError(function(event, jqXHR, ajaxSettings, thrownError) {
                $(this).html("<div style='color:red;'>Error<p>" + jqXHR.responseText + "</p></div>");
            });
            $.get(adminHost + '/api', undefined, function(response) {
                services = JSON.parse(response);
                initServices();
            })
        })($);
    </script>
</html>
